<!-- WorkBoard – My Tasks  |  ERPNext Web Page  -->
<!-- Paste everything below into Web Page → Main Section (HTML) -->
<!-- Also add the Font Awesome CDN in Web Page → Header HTML -->

<style>
/* ── Reset & Base ── */
#wb-app * { box-sizing: border-box; margin: 0; padding: 0; }
#wb-app {
  background-color: #f0f2f5;
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  color: #334155;
  font-size: 14px;
  line-height: 1.5;
  min-height: 80vh;
  /* Compensate for ERPNext navbar */
  margin: -15px -15px 0 -15px;
}
#wb-app .hidden { display: none !important; }

/* ── Header ── */
#wb-app .wb-top-bar {
  display: flex;
  align-items: center;
  gap: 0.6rem;
  padding: 0.65rem 1rem;
  background: #fff;
  border-bottom: 2px solid #f1f5f9;
  position: sticky;
  top: 0;
  z-index: 200;
}
#wb-app .wb-icon-circle {
  width: 38px; height: 38px;
  background: #3b82f6;
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
}
#wb-app .wb-icon-circle i { color: #fff; font-size: 1rem; }
#wb-app .wb-top-bar h1 { font-size: 1.15rem; font-weight: 800; color: #1e293b; line-height: 1.2; }
#wb-app .wb-top-bar p { font-size: 0.7rem; color: #94a3b8; }
#wb-app .wb-header-actions { margin-left: auto; display: flex; gap: 0.4rem; }
#wb-app .wb-refresh-btn {
  width: 38px; height: 38px;
  background: none;
  border: 1.5px solid #e2e8f0;
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  color: #64748b;
  font-size: 0.85rem;
  transition: all 0.15s;
}
#wb-app .wb-refresh-btn:hover { background: #eff6ff; border-color: #3b82f6; color: #3b82f6; }
#wb-app .wb-refresh-btn.spinning i { animation: wb-spin 0.7s linear infinite; }
@keyframes wb-spin { to { transform: rotate(360deg); } }

/* ── Tab Navigation ── */
#wb-app .wb-tab-nav {
  display: flex;
  background: #fff;
  border-bottom: 2px solid #f1f5f9;
  position: sticky;
  top: 57px;
  z-index: 199;
}
#wb-app .wb-tab-btn {
  flex: 1;
  padding: 0.75rem 0.5rem;
  border: none;
  border-bottom: 2.5px solid transparent;
  font-weight: 700;
  font-size: 0.8rem;
  cursor: pointer;
  background: none;
  color: #94a3b8;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.4rem;
  transition: all 0.2s;
  font-family: inherit;
}
#wb-app .wb-tab-btn.active { color: #3b82f6; border-bottom-color: #3b82f6; }
#wb-app .wb-tab-btn:hover:not(.active) { color: #64748b; }
#wb-app .wb-tab-badge {
  background: #ef4444;
  color: #fff;
  font-size: 0.6rem;
  font-weight: 700;
  min-width: 18px; height: 18px;
  border-radius: 999px;
  display: inline-flex;
  align-items: center; justify-content: center;
  padding: 0 5px;
}

/* ── Layout ── */
#wb-app .wb-main {
  display: flex;
  min-height: calc(100vh - 115px);
  padding: 0.75rem;
  max-width: 900px;
  margin: 0 auto;
}
#wb-app .wb-panel { flex: 1; display: flex; flex-direction: column; gap: 0.6rem; min-width: 0; }
#wb-app .wb-tab-content { display: none; flex-direction: column; gap: 0.6rem; }
#wb-app .wb-tab-content.active { display: flex; }

/* ── Cards ── */
#wb-app .wb-card {
  background: #fff;
  border-radius: 1rem;
  padding: 0.85rem;
  box-shadow: 0 1px 3px rgba(0,0,0,0.06);
}

/* ── Filter Bar ── */
#wb-app .wb-filter-bar {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  flex-wrap: wrap;
  padding: 0.65rem 0.85rem;
}
#wb-app .wb-filter-label {
  font-size: 0.72rem;
  font-weight: 700;
  color: #64748b;
  text-transform: uppercase;
  letter-spacing: 0.03em;
  white-space: nowrap;
}
#wb-app .wb-filter-chips { display: flex; gap: 0.35rem; flex-wrap: wrap; }
#wb-app .wb-chip {
  padding: 0.3rem 0.75rem;
  border: 1.5px solid #e2e8f0;
  border-radius: 999px;
  font-size: 0.72rem;
  font-weight: 700;
  cursor: pointer;
  background: #fff;
  color: #64748b;
  transition: all 0.15s;
  font-family: inherit;
}
#wb-app .wb-chip:hover { border-color: #3b82f6; color: #3b82f6; }
#wb-app .wb-chip.active { background: #3b82f6; border-color: #3b82f6; color: #fff; }

/* ── Stats Row ── */
#wb-app .wb-stats-row {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 0.5rem;
}
#wb-app .wb-stat-cell {
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border: 1.5px solid #e2e8f0;
  border-radius: 0.75rem;
  padding: 0.6rem 0.75rem;
  text-align: center;
}
#wb-app .wb-stat-num { font-size: 1.5rem; font-weight: 800; color: #1e293b; line-height: 1; }
#wb-app .wb-stat-num.red { color: #dc2626; }
#wb-app .wb-stat-num.blue { color: #2563eb; }
#wb-app .wb-stat-num.purple { color: #7c3aed; }
#wb-app .wb-stat-lbl { font-size: 0.62rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.03em; margin-top: 0.2rem; }

/* ── Task Cards ── */
#wb-app .wb-tasks-list { display: flex; flex-direction: column; gap: 0.5rem; }
#wb-app .wb-task-card {
  background: #fff;
  border: 1.5px solid #e2e8f0;
  border-radius: 0.85rem;
  padding: 0.75rem 0.85rem;
  display: flex;
  gap: 0.7rem;
  align-items: flex-start;
  transition: all 0.2s ease;
  position: relative;
  overflow: hidden;
  cursor: pointer;
}
#wb-app .wb-task-card::before {
  content: '';
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 4px;
}
#wb-app .wb-task-card.priority-High::before { background: #ef4444; }
#wb-app .wb-task-card.priority-Medium::before { background: #f59e0b; }
#wb-app .wb-task-card.priority-Low::before { background: #10b981; }
#wb-app .wb-task-card:hover { border-color: #3b82f6; box-shadow: 0 4px 12px rgba(59,130,246,0.12); transform: translateY(-1px); }
#wb-app .wb-task-card.status-Overdue { animation: wb-pulseRed 2.5s ease infinite; }
@keyframes wb-pulseRed { 0%,100%{border-color:#fca5a5;} 50%{border-color:#ef4444;} }

#wb-app .wb-task-card-body { flex: 1; min-width: 0; }
#wb-app .wb-task-top-row {
  display: flex;
  align-items: flex-start;
  gap: 0.5rem;
  margin-bottom: 0.3rem;
  flex-wrap: wrap;
}
#wb-app .wb-task-title {
  font-size: 0.9rem;
  font-weight: 700;
  color: #1e293b;
  flex: 1;
  min-width: 0;
  line-height: 1.3;
}
#wb-app .wb-task-title.done-text { text-decoration: line-through; color: #94a3b8; }

/* Badges */
#wb-app .wb-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.25rem;
  padding: 0.15rem 0.55rem;
  border-radius: 999px;
  font-size: 0.62rem;
  font-weight: 700;
  white-space: nowrap;
  flex-shrink: 0;
}
#wb-app .wb-badge-High { background: #fee2e2; color: #dc2626; }
#wb-app .wb-badge-Medium { background: #fef3c7; color: #d97706; }
#wb-app .wb-badge-Low { background: #dcfce7; color: #16a34a; }
#wb-app .wb-badge-Open { background: #dbeafe; color: #2563eb; }
#wb-app .wb-badge-Overdue { background: #fee2e2; color: #dc2626; }
#wb-app .wb-badge-Done { background: #ede9fe; color: #7c3aed; }
#wb-app .wb-badge-Completed { background: #dcfce7; color: #16a34a; }
#wb-app .wb-badge-Manual { background: #f1f5f9; color: #64748b; }
#wb-app .wb-badge-Auto { background: #fef3c7; color: #92400e; }
#wb-app .wb-badge-time { background: #fef3c7; color: #b45309; }

/* Task Meta */
#wb-app .wb-task-meta {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  flex-wrap: wrap;
  margin-top: 0.35rem;
}
#wb-app .wb-meta-item {
  display: flex;
  align-items: center;
  gap: 0.25rem;
  font-size: 0.68rem;
  color: #64748b;
  font-weight: 600;
}
#wb-app .wb-meta-item i { font-size: 0.62rem; color: #94a3b8; }
#wb-app .wb-meta-item.overdue { color: #dc2626; }
#wb-app .wb-meta-item.overdue i { color: #dc2626; }
#wb-app .wb-meta-item.time-left { color: #b45309; }
#wb-app .wb-meta-item.time-left i { color: #b45309; }
#wb-app .wb-meta-item.expired { color: #dc2626; }
#wb-app .wb-meta-item.expired i { color: #dc2626; }

#wb-app .wb-assignee-pill {
  display: inline-flex;
  align-items: center;
  gap: 0.3rem;
  background: #f1f5f9;
  border-radius: 999px;
  padding: 0.2rem 0.55rem;
  font-size: 0.67rem;
  font-weight: 700;
  color: #475569;
}
#wb-app .wb-assignee-pill i { font-size: 0.62rem; color: #94a3b8; }

/* Task Action Buttons */
#wb-app .wb-task-actions { display: flex; flex-direction: column; gap: 0.35rem; align-items: flex-end; flex-shrink: 0; }
#wb-app .wb-action-btn {
  padding: 0.45rem 0.85rem;
  border: none;
  border-radius: 0.55rem;
  font-weight: 700;
  font-size: 0.72rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 0.3rem;
  white-space: nowrap;
  font-family: inherit;
  transition: all 0.15s;
}
#wb-app .wb-action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
#wb-app .wb-btn-done {
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  color: #fff;
  box-shadow: 0 2px 6px rgba(59,130,246,0.3);
}
#wb-app .wb-btn-done:hover:not(:disabled) { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); }
#wb-app .wb-btn-complete {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: #fff;
  box-shadow: 0 2px 6px rgba(16,185,129,0.3);
}
#wb-app .wb-btn-complete:hover:not(:disabled) { background: linear-gradient(135deg, #059669 0%, #047857 100%); }

/* ── Group Headers ── */
#wb-app .wb-group-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.5rem 0;
  cursor: pointer;
  user-select: none;
}
#wb-app .wb-group-title {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.8rem;
  font-weight: 800;
  color: #1e293b;
}
#wb-app .wb-group-count {
  background: #e2e8f0;
  color: #475569;
  font-size: 0.65rem;
  font-weight: 700;
  min-width: 22px; height: 22px;
  border-radius: 999px;
  display: inline-flex;
  align-items: center; justify-content: center;
  padding: 0 6px;
}
#wb-app .wb-group-chevron { color: #94a3b8; font-size: 0.75rem; transition: transform 0.2s; }
#wb-app .wb-group-header.open .wb-group-chevron { transform: rotate(90deg); }
#wb-app .wb-group-content { display: none; padding-top: 0.5rem; }
#wb-app .wb-group-content.open { display: flex; flex-direction: column; gap: 0.4rem; }

/* ── Empty / Loading States ── */
#wb-app .wb-empty-state {
  text-align: center;
  padding: 3rem 1rem;
  color: #94a3b8;
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border-radius: 0.85rem;
  border: 2px dashed #e2e8f0;
}
#wb-app .wb-empty-state i { font-size: 3rem; margin-bottom: 0.75rem; opacity: 0.3; display: block; color: #cbd5e1; }
#wb-app .wb-empty-state p { font-size: 0.85rem; font-weight: 600; color: #64748b; margin: 0; }
#wb-app .wb-empty-state span { font-size: 0.75rem; color: #94a3b8; margin-top: 0.25rem; display: block; }
#wb-app .wb-loading-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 3rem 1rem;
  gap: 0.75rem;
  color: #64748b;
  font-size: 0.8rem;
  font-weight: 600;
  background: #fff;
  border-radius: 1rem;
  box-shadow: 0 1px 3px rgba(0,0,0,0.06);
}
#wb-app .wb-spinner {
  width: 36px; height: 36px;
  border: 3px solid #e2e8f0;
  border-top-color: #3b82f6;
  border-radius: 50%;
  animation: wb-spin 0.7s linear infinite;
}

/* ── Overdue Banner ── */
#wb-app .wb-overdue-banner {
  background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
  border: 1.5px solid #fca5a5;
  border-radius: 0.75rem;
  padding: 0.65rem 0.85rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.75rem;
  font-weight: 700;
  color: #991b1b;
}
#wb-app .wb-overdue-banner i { font-size: 0.85rem; }

/* ── Modal ── */
#wb-modal-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.45);
  backdrop-filter: blur(4px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  padding: 1rem;
  animation: wb-fadeIn 0.2s ease;
}
@keyframes wb-fadeIn { from{opacity:0} to{opacity:1} }
#wb-modal-overlay.hidden { display: none !important; }
#wb-modal-content {
  background: #fff;
  border-radius: 1rem;
  padding: 1.25rem;
  max-width: 520px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 50px rgba(0,0,0,0.25);
  animation: wb-slideUp 0.25s ease-out;
}
@keyframes wb-slideUp { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
.wb-modal-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 0.75rem;
  margin-bottom: 1rem;
  padding-bottom: 0.85rem;
  border-bottom: 2px solid #f1f5f9;
}
.wb-modal-title { font-size: 1.05rem; font-weight: 800; color: #1e293b; line-height: 1.3; }
.wb-modal-subtitle { font-size: 0.72rem; color: #94a3b8; margin-top: 0.15rem; font-weight: 600; }
.wb-modal-close {
  background: none; border: none; color: #94a3b8;
  cursor: pointer; padding: 0.25rem; font-size: 1.1rem; flex-shrink: 0;
  transition: color 0.15s;
}
.wb-modal-close:hover { color: #ef4444; }
.wb-modal-badges { display: flex; gap: 0.4rem; flex-wrap: wrap; margin-bottom: 0.85rem; }
.wb-detail-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0.5rem;
  margin-bottom: 0.85rem;
}
.wb-detail-cell {
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border: 1px solid #e2e8f0;
  border-radius: 0.65rem;
  padding: 0.6rem 0.7rem;
  display: flex;
  align-items: flex-start;
  gap: 0.45rem;
}
.wb-cell-icon {
  width: 28px; height: 28px;
  border-radius: 0.45rem;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
  font-size: 0.7rem;
}
.wb-cell-icon.blue{background:#dbeafe;color:#2563eb}
.wb-cell-icon.red{background:#fee2e2;color:#dc2626}
.wb-cell-icon.amber{background:#fef3c7;color:#d97706}
.wb-cell-icon.green{background:#dcfce7;color:#16a34a}
.wb-cell-icon.purple{background:#ede9fe;color:#7c3aed}
.wb-cell-icon.gray{background:#f1f5f9;color:#64748b}
.wb-cell-text .label{font-size:0.6rem;color:#94a3b8;text-transform:uppercase;letter-spacing:0.04em;font-weight:600}
.wb-cell-text .value{font-size:0.82rem;font-weight:700;color:#1e293b;margin-top:0.05rem;word-break:break-word}
.wb-desc-section{margin-bottom:0.85rem}
.wb-desc-label{font-size:0.68rem;font-weight:700;color:#94a3b8;text-transform:uppercase;letter-spacing:0.04em;margin-bottom:0.4rem}
.wb-desc-body{background:#f8fafc;border:1px solid #e2e8f0;border-radius:0.65rem;padding:0.65rem 0.75rem;font-size:0.8rem;color:#475569;line-height:1.6;max-height:150px;overflow-y:auto}
.wb-desc-body p{margin:0}
.wb-modal-actions{display:flex;gap:0.5rem;padding-top:0.85rem;border-top:2px solid #f1f5f9}
.wb-modal-action-btn{flex:1;padding:0.65rem;border:none;border-radius:0.75rem;font-weight:700;font-size:0.82rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:0.35rem;font-family:inherit;transition:all 0.15s}
.wb-modal-action-btn:disabled{opacity:0.5;cursor:not-allowed}
.wb-modal-action-btn.secondary{background:#f8fafc;color:#64748b;border:1.5px solid #e2e8f0}
.wb-modal-action-btn.secondary:hover{background:#f1f5f9}
.wb-modal-action-btn.primary-done{background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);color:#fff;box-shadow:0 3px 8px rgba(59,130,246,0.3)}
.wb-modal-action-btn.primary-done:hover:not(:disabled){background:linear-gradient(135deg,#2563eb 0%,#1d4ed8 100%)}
.wb-modal-action-btn.primary-complete{background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:#fff;box-shadow:0 3px 8px rgba(16,185,129,0.3)}
.wb-modal-action-btn.primary-complete:hover:not(:disabled){background:linear-gradient(135deg,#059669 0%,#047857 100%)}

/* ── Toast ── */
#wb-toast{
  position:fixed;bottom:1.5rem;left:50%;
  transform:translateX(-50%) translateY(80px);
  background:#1e293b;color:#fff;
  padding:0.65rem 1.25rem;border-radius:0.75rem;
  font-size:0.8rem;font-weight:600;
  display:flex;align-items:center;gap:0.5rem;
  z-index:99999;transition:transform 0.3s ease;
  max-width:calc(100vw - 2rem);
  box-shadow:0 8px 24px rgba(0,0,0,0.2);
  pointer-events:none;
}
#wb-toast.show{transform:translateX(-50%) translateY(0)}
#wb-toast.success i{color:#4ade80}
#wb-toast.error i{color:#f87171}
#wb-toast.info i{color:#60a5fa}

/* ── Responsive ── */
@media(max-width:640px){
  #wb-app .wb-top-bar h1{font-size:1rem}
  #wb-app .wb-main{padding:0.5rem}
  .wb-detail-grid{grid-template-columns:1fr 1fr}
}
</style>

<!-- ── App Shell ── -->
<div id="wb-app">

  <!-- Header -->
  <div class="wb-top-bar">
    <div class="wb-icon-circle"><i class="fa-solid fa-list-check"></i></div>
    <div>
      <h1>WorkBoard Tasks</h1>
      <p id="wb-user-label">Loading…</p>
    </div>
    <div class="wb-header-actions">
      <button class="wb-refresh-btn" id="wb-refresh-btn" title="Refresh" onclick="wbRefresh()">
        <i class="fa-solid fa-rotate-right"></i>
      </button>
    </div>
  </div>

  <!-- Tab Navigation -->
  <div class="wb-tab-nav">
    <button class="wb-tab-btn active" id="wb-my-tab" onclick="wbSwitchTab('my')">
      <i class="fa-solid fa-user-check"></i>
      My Tasks
      <span class="wb-tab-badge" id="wb-my-badge">0</span>
    </button>
    <button class="wb-tab-btn" id="wb-assigned-tab" onclick="wbSwitchTab('assigned')">
      <i class="fa-solid fa-people-arrows"></i>
      Assigned by Me
      <span class="wb-tab-badge hidden" id="wb-assigned-badge">0</span>
    </button>
  </div>

  <!-- Main Content -->
  <div class="wb-main">
    <div class="wb-panel">

      <!-- ══ MY TASKS ══ -->
      <div class="wb-tab-content active" id="wb-my-content">
        <!-- Stats -->
        <div class="wb-card">
          <div class="wb-stats-row">
            <div class="wb-stat-cell">
              <div class="wb-stat-num red" id="wb-stat-overdue">0</div>
              <div class="wb-stat-lbl">Overdue</div>
            </div>
            <div class="wb-stat-cell">
              <div class="wb-stat-num blue" id="wb-stat-open">0</div>
              <div class="wb-stat-lbl">Open</div>
            </div>
            <div class="wb-stat-cell">
              <div class="wb-stat-num purple" id="wb-stat-done">0</div>
              <div class="wb-stat-lbl">Done</div>
            </div>
          </div>
        </div>

        <!-- Filter -->
        <div class="wb-card" style="padding:0;">
          <div class="wb-filter-bar">
            <span class="wb-filter-label"><i class="fa-solid fa-filter" style="margin-right:0.3rem;"></i>Show:</span>
            <div class="wb-filter-chips" id="wb-my-filter">
              <button class="wb-chip active" data-filter="active" onclick="wbSetMyFilter('active')">Active</button>
              <button class="wb-chip" data-filter="today" onclick="wbSetMyFilter('today')">Due Today</button>
              <button class="wb-chip" data-filter="overdue" onclick="wbSetMyFilter('overdue')">Overdue</button>
              <button class="wb-chip" data-filter="all" onclick="wbSetMyFilter('all')">All Open</button>
            </div>
          </div>
        </div>

        <!-- Overdue Banner -->
        <div class="wb-overdue-banner hidden" id="wb-overdue-banner">
          <i class="fa-solid fa-triangle-exclamation"></i>
          <span id="wb-overdue-banner-text"></span>
        </div>

        <!-- Tasks List -->
        <div id="wb-my-list">
          <div class="wb-loading-state"><div class="wb-spinner"></div><span>Loading your tasks…</span></div>
        </div>
      </div><!-- /my-content -->

      <!-- ══ ASSIGNED BY ME ══ -->
      <div class="wb-tab-content" id="wb-assigned-content">
        <!-- Filter -->
        <div class="wb-card" style="padding:0;">
          <div class="wb-filter-bar">
            <span class="wb-filter-label"><i class="fa-solid fa-filter" style="margin-right:0.3rem;"></i>Status:</span>
            <div class="wb-filter-chips" id="wb-assigned-filter">
              <button class="wb-chip active" data-filter="all" onclick="wbSetAssignedFilter('all')">All</button>
              <button class="wb-chip" data-filter="Open" onclick="wbSetAssignedFilter('Open')">Open</button>
              <button class="wb-chip" data-filter="Overdue" onclick="wbSetAssignedFilter('Overdue')">Overdue</button>
              <button class="wb-chip" data-filter="Done" onclick="wbSetAssignedFilter('Done')">Done</button>
              <button class="wb-chip" data-filter="Completed" onclick="wbSetAssignedFilter('Completed')">Completed</button>
            </div>
          </div>
        </div>

        <!-- Assigned Tasks List -->
        <div id="wb-assigned-list">
          <div class="wb-loading-state"><div class="wb-spinner"></div><span>Loading assigned tasks…</span></div>
        </div>
      </div><!-- /assigned-content -->

    </div><!-- /panel -->
  </div><!-- /main -->
</div><!-- /app -->

<!-- ── Detail Modal ── -->
<div id="wb-modal-overlay" class="hidden">
  <div id="wb-modal-content">
    <div class="wb-modal-header">
      <div>
        <div class="wb-modal-title" id="wb-modal-title">Task Title</div>
        <div class="wb-modal-subtitle" id="wb-modal-subtitle">Task-0000</div>
      </div>
      <button class="wb-modal-close" onclick="wbCloseModal()"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="wb-modal-badges" id="wb-modal-badges"></div>
    <div class="wb-detail-grid" id="wb-modal-detail-grid"></div>
    <div class="wb-desc-section hidden" id="wb-modal-desc-section">
      <div class="wb-desc-label"><i class="fa-solid fa-align-left" style="margin-right:0.3rem;"></i>Description</div>
      <div class="wb-desc-body" id="wb-modal-description"></div>
    </div>
    <div class="wb-modal-actions" id="wb-modal-actions"></div>
  </div>
</div>

<!-- ── Toast ── -->
<div id="wb-toast"><i class="fa-solid fa-circle-check"></i><span id="wb-toast-msg"></span></div>

<script>
(function() {
'use strict';

// ══════════════════════════════════════════════
//  State
// ══════════════════════════════════════════════
var WB = {
  currentUser: '',
  myTasks: [],
  assignedTasks: [],
  myFilter: 'active',
  assignedFilter: 'all',
  modalTask: null,
  modalContext: '',
  FIELDS: ['name','title','priority','status','due_date',
           'depends_on_time','end_datetime','assign_from','assign_to',
           'task_type','description','has_checklist','timeliness']
};

// ══════════════════════════════════════════════
//  Helpers
// ══════════════════════════════════════════════
function $id(id) { return document.getElementById(id); }

function esc(s) {
  return String(s == null ? '' : s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

function todayStr() { return new Date().toISOString().split('T')[0]; }

function fmtDate(d) {
  if (!d) return '–';
  var dt = new Date(d);
  return dt.toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'});
}

function fmtDatetime(d) {
  if (!d) return '–';
  var dt = new Date(d);
  return dt.toLocaleDateString('en-IN',{day:'numeric',month:'short'}) + ' ' +
         dt.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});
}

function timeLeft(endDt) {
  var diff = new Date(endDt) - new Date();
  if (diff <= 0) return {expired:true,label:'Time expired'};
  var mins = Math.floor(diff/60000);
  if (mins < 60) return {expired:false,label:mins+'m left'};
  var hrs = Math.floor(mins/60);
  return {expired:false,label:hrs+'h '+(mins%60)+'m left'};
}

function showToast(msg, type) {
  type = type || 'success';
  var t = $id('wb-toast');
  var icons = {success:'fa-circle-check',error:'fa-circle-xmark',info:'fa-circle-info'};
  t.className = 'wb-toast ' + type;  // reset
  t.querySelector('i').className = 'fa-solid ' + (icons[type]||icons.success);
  $id('wb-toast-msg').textContent = msg;
  t.classList.add('show');
  setTimeout(function(){t.classList.remove('show');}, 3000);
}

// ══════════════════════════════════════════════
//  Tab Switching
// ══════════════════════════════════════════════
window.wbSwitchTab = function(tab) {
  ['my','assigned'].forEach(function(t){
    var btn = $id('wb-'+t+'-tab');
    var content = $id('wb-'+t+'-content');
    var isActive = (t === tab);
    if (btn) { btn.classList.toggle('active', isActive); }
    if (content) {
      content.classList.toggle('active', isActive);
    }
  });
};

// ══════════════════════════════════════════════
//  Filters
// ══════════════════════════════════════════════
window.wbSetMyFilter = function(f) {
  WB.myFilter = f;
  document.querySelectorAll('#wb-my-filter .wb-chip').forEach(function(c){
    c.classList.toggle('active', c.dataset.filter === f);
  });
  wbRenderMyTasks();
};

window.wbSetAssignedFilter = function(f) {
  WB.assignedFilter = f;
  document.querySelectorAll('#wb-assigned-filter .wb-chip').forEach(function(c){
    c.classList.toggle('active', c.dataset.filter === f);
  });
  wbRenderAssignedTasks();
};

// ══════════════════════════════════════════════
//  Stats
// ══════════════════════════════════════════════
function wbUpdateStats() {
  var open = WB.myTasks.filter(function(t){return t.status==='Open';}).length;
  var overdue = WB.myTasks.filter(function(t){return t.status==='Overdue';}).length;
  var done = WB.myTasks.filter(function(t){return t.status==='Done';}).length;
  $id('wb-stat-open').textContent = open;
  $id('wb-stat-overdue').textContent = overdue;
  $id('wb-stat-done').textContent = done;

  var active = open + overdue;
  var badge = $id('wb-my-badge');
  badge.textContent = active;
  badge.classList.toggle('hidden', active === 0);

  var banner = $id('wb-overdue-banner');
  if (overdue > 0) {
    $id('wb-overdue-banner-text').textContent =
      'You have ' + overdue + ' overdue task' + (overdue>1?'s':'') + ' — please action them urgently.';
    banner.classList.remove('hidden');
  } else {
    banner.classList.add('hidden');
  }
}

function wbUpdateAssignedBadge() {
  var pending = WB.assignedTasks.filter(function(t){
    return ['Open','Overdue','Done'].includes(t.status);
  }).length;
  var badge = $id('wb-assigned-badge');
  badge.textContent = pending;
  badge.classList.toggle('hidden', pending === 0);
}

// ══════════════════════════════════════════════
//  Task Card HTML
// ══════════════════════════════════════════════
function taskCardHTML(task, context) {
  var today = todayStr();
  var overdueClass = task.status === 'Overdue' ? 'status-Overdue' : '';
  var titleClass = ['Done','Completed'].includes(task.status) ? 'done-text' : '';

  // Time meta
  var timeMeta = '';
  if (task.depends_on_time && task.end_datetime) {
    var tl = timeLeft(task.end_datetime);
    var cls = tl.expired ? 'expired' : 'time-left';
    var ico = tl.expired ? 'fa-hourglass-end' : 'fa-hourglass-half';
    timeMeta = '<span class="wb-meta-item '+cls+'"><i class="fa-solid '+ico+'"></i>'+tl.label+'</span>';
  }

  // Date meta
  var dateMeta = '';
  if (task.due_date) {
    var isOverdue = task.due_date < today && !['Done','Completed'].includes(task.status);
    var dcls = isOverdue ? 'overdue' : '';
    dateMeta = '<span class="wb-meta-item '+dcls+'"><i class="fa-regular fa-calendar"></i>'+(isOverdue?'Due: ':'')+fmtDate(task.due_date)+'</span>';
  }

  // Assignee meta
  var assigneeMeta = '';
  if (context === 'assigned' && task.assign_to) {
    assigneeMeta = '<span class="wb-assignee-pill"><i class="fa-solid fa-user"></i>'+esc(task.assign_to)+'</span>';
  } else if (context === 'mine' && task.assign_from) {
    assigneeMeta = '<span class="wb-assignee-pill"><i class="fa-solid fa-user-tie"></i>'+esc(task.assign_from)+'</span>';
  }

  // Action button
  var actionBtn = '';
  if (context === 'mine') {
    if (['Open','Overdue'].includes(task.status) && task.task_type === 'Manual') {
      actionBtn = '<button class="wb-action-btn wb-btn-done" onclick="event.stopPropagation();wbMarkDone(\''+esc(task.name)+'\',this)"><i class="fa-solid fa-check"></i>Mark Done</button>';
    } else if (['Open','Overdue'].includes(task.status) && task.task_type === 'Auto') {
      actionBtn = '<button class="wb-action-btn wb-btn-complete" onclick="event.stopPropagation();wbMarkCompleted(\''+esc(task.name)+'\',this)"><i class="fa-solid fa-check-double"></i>Complete</button>';
    }
  } else if (context === 'assigned' && task.status === 'Done') {
    actionBtn = '<button class="wb-action-btn wb-btn-complete" onclick="event.stopPropagation();wbMarkCompleted(\''+esc(task.name)+'\',this)"><i class="fa-solid fa-circle-check"></i>Approve</button>';
  }

  return '<div class="wb-task-card priority-'+esc(task.priority)+' '+overdueClass+'" onclick="wbOpenModal(\''+esc(task.name)+'\',\''+context+'\')">'+
    '<div class="wb-task-card-body">'+
      '<div class="wb-task-top-row">'+
        '<div class="wb-task-title '+titleClass+'">'+esc(task.title)+'</div>'+
        '<span class="wb-badge wb-badge-'+esc(task.status)+'">'+esc(task.status)+'</span>'+
        '<span class="wb-badge wb-badge-'+esc(task.priority)+'">'+esc(task.priority)+'</span>'+
      '</div>'+
      '<div class="wb-task-meta">'+dateMeta+timeMeta+assigneeMeta+
        (task.has_checklist?'<span class="wb-meta-item"><i class="fa-solid fa-list-check"></i>Checklist</span>':'')+
        (task.task_type==='Auto'?'<span class="wb-meta-item"><i class="fa-solid fa-robot"></i>Auto</span>':'')+
      '</div>'+
    '</div>'+
    (actionBtn?'<div class="wb-task-actions">'+actionBtn+'</div>':'')+
  '</div>';
}

// ══════════════════════════════════════════════
//  Render My Tasks
// ══════════════════════════════════════════════
function wbFilterMyTasks() {
  var today = todayStr();
  switch (WB.myFilter) {
    case 'today':   return WB.myTasks.filter(function(t){return t.due_date===today && !['Done','Completed'].includes(t.status);});
    case 'overdue': return WB.myTasks.filter(function(t){return t.status==='Overdue';});
    case 'all':     return WB.myTasks.filter(function(t){return t.status!=='Completed';});
    default:        return WB.myTasks.filter(function(t){return ['Open','Overdue'].includes(t.status);});
  }
}

function wbRenderMyTasks() {
  var tasks = wbFilterMyTasks();
  var el = $id('wb-my-list');
  if (tasks.length === 0) {
    el.innerHTML = '<div class="wb-empty-state wb-card"><i class="fa-solid fa-circle-check"></i><p>No tasks to show</p><span>You\'re all caught up!</span></div>';
    return;
  }
  el.innerHTML = '<div class="wb-tasks-list">'+tasks.map(function(t){return taskCardHTML(t,'mine');}).join('')+'</div>';
}

// ══════════════════════════════════════════════
//  Render Assigned Tasks (grouped by assignee)
// ══════════════════════════════════════════════
function wbFilterAssigned() {
  if (WB.assignedFilter === 'all') return WB.assignedTasks;
  return WB.assignedTasks.filter(function(t){return t.status===WB.assignedFilter;});
}

function wbRenderAssignedTasks() {
  var tasks = wbFilterAssigned();
  var el = $id('wb-assigned-list');
  if (tasks.length === 0) {
    el.innerHTML = '<div class="wb-empty-state wb-card"><i class="fa-solid fa-people-arrows"></i><p>No tasks assigned by you</p><span>'+(WB.assignedFilter==='all'?'Tasks you assign will appear here':'No '+WB.assignedFilter+' tasks')+'</span></div>';
    return;
  }

  // Group by assignee
  var grouped = {};
  tasks.forEach(function(t){ var k = t.assign_to||'Unknown'; if(!grouped[k]) grouped[k]=[]; grouped[k].push(t); });

  var html = Object.keys(grouped).map(function(assignee){
    var items = grouped[assignee];
    return '<div class="wb-card" style="padding:0.6rem 0.85rem;display:flex;flex-direction:column;gap:0;">'+
      '<div class="wb-group-header open" onclick="wbToggleGroup(this)">'+
        '<div class="wb-group-title">'+
          '<i class="fa-solid fa-user" style="color:#3b82f6;font-size:0.75rem;"></i>'+
          esc(assignee)+
          '<span class="wb-group-count">'+items.length+'</span>'+
        '</div>'+
        '<i class="fa-solid fa-chevron-right wb-group-chevron"></i>'+
      '</div>'+
      '<div class="wb-group-content open">'+
        items.map(function(t){return taskCardHTML(t,'assigned');}).join('')+
      '</div>'+
    '</div>';
  }).join('');

  el.innerHTML = html;
}

// ══════════════════════════════════════════════
//  Group Toggle
// ══════════════════════════════════════════════
window.wbToggleGroup = function(header) {
  header.classList.toggle('open');
  var content = header.nextElementSibling;
  if (content) content.classList.toggle('open');
};

// ══════════════════════════════════════════════
//  API Calls
// ══════════════════════════════════════════════
window.wbMarkDone = function(taskName, btn) {
  if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>'; }
  frappe.call({
    method: 'run_doc_method',
    args: { dt: 'WB Task', dn: taskName, method: 'mark_done' },
    freeze: false,
    callback: function(r) {
      showToast('Task marked as Done!', 'success');
      var idx = WB.myTasks.findIndex(function(t){return t.name===taskName;});
      if (idx !== -1) WB.myTasks[idx].status = 'Done';
      if (WB.modalTask && WB.modalTask.name === taskName) { WB.modalTask.status = 'Done'; wbRenderModalActions(); }
      wbUpdateStats(); wbRenderMyTasks();
      setTimeout(wbFetchMyTasks, 500);
    },
    error: function() {
      showToast('Failed to mark done. Check permissions.', 'error');
      if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-check"></i>Mark Done'; }
    }
  });
};

window.wbMarkCompleted = function(taskName, btn) {
  if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>'; }
  frappe.call({
    method: 'run_doc_method',
    args: { dt: 'WB Task', dn: taskName, method: 'mark_completed' },
    freeze: false,
    callback: function(r) {
      showToast('Task marked as Completed!', 'success');
      [WB.myTasks, WB.assignedTasks].forEach(function(list){
        var idx = list.findIndex(function(t){return t.name===taskName;});
        if (idx !== -1) list[idx].status = 'Completed';
      });
      if (WB.modalTask && WB.modalTask.name === taskName) { WB.modalTask.status = 'Completed'; wbRenderModalActions(); }
      wbUpdateStats(); wbUpdateAssignedBadge(); wbRenderMyTasks(); wbRenderAssignedTasks();
      setTimeout(function(){ wbFetchMyTasks(); wbFetchAssignedTasks(); }, 500);
    },
    error: function() {
      showToast('Failed to complete. Check permissions.', 'error');
      if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-circle-check"></i>Approve'; }
    }
  });
};

// ══════════════════════════════════════════════
//  Data Fetch
// ══════════════════════════════════════════════
function wbFetchMyTasks() {
  $id('wb-my-list').innerHTML = '<div class="wb-loading-state"><div class="wb-spinner"></div><span>Loading your tasks…</span></div>';
  frappe.call({
    method: 'frappe.client.get_list',
    args: { doctype: 'WB Task', fields: WB.FIELDS, filters: [['assign_to','=',WB.currentUser]], order_by: 'due_date asc', limit_page_length: 200 },
    callback: function(r) {
      WB.myTasks = r.message || [];
      wbUpdateStats();
      wbRenderMyTasks();
    },
    error: function() {
      $id('wb-my-list').innerHTML = '<div class="wb-empty-state wb-card"><i class="fa-solid fa-triangle-exclamation"></i><p>Failed to load tasks</p><span>Check your connection</span></div>';
    }
  });
}

function wbFetchAssignedTasks() {
  $id('wb-assigned-list').innerHTML = '<div class="wb-loading-state"><div class="wb-spinner"></div><span>Loading assigned tasks…</span></div>';
  frappe.call({
    method: 'frappe.client.get_list',
    args: { doctype: 'WB Task', fields: WB.FIELDS, filters: [['assign_from','=',WB.currentUser]], order_by: 'status asc, due_date asc', limit_page_length: 200 },
    callback: function(r) {
      WB.assignedTasks = (r.message||[]).filter(function(t){return t.assign_to!==WB.currentUser;});
      wbUpdateAssignedBadge();
      wbRenderAssignedTasks();
    },
    error: function() {
      $id('wb-assigned-list').innerHTML = '<div class="wb-empty-state wb-card"><i class="fa-solid fa-triangle-exclamation"></i><p>Failed to load</p><span>Check your connection</span></div>';
    }
  });
}

// ══════════════════════════════════════════════
//  Refresh Button
// ══════════════════════════════════════════════
window.wbRefresh = function() {
  var btn = $id('wb-refresh-btn');
  btn.classList.add('spinning');
  var done = 0;
  var finish = function(){ if(++done===2) btn.classList.remove('spinning'); };
  frappe.call({
    method:'frappe.client.get_list',
    args:{doctype:'WB Task',fields:WB.FIELDS,filters:[['assign_to','=',WB.currentUser]],order_by:'due_date asc',limit_page_length:200},
    callback:function(r){WB.myTasks=r.message||[];wbUpdateStats();wbRenderMyTasks();finish();},error:finish
  });
  frappe.call({
    method:'frappe.client.get_list',
    args:{doctype:'WB Task',fields:WB.FIELDS,filters:[['assign_from','=',WB.currentUser]],order_by:'status asc',limit_page_length:200},
    callback:function(r){WB.assignedTasks=(r.message||[]).filter(function(t){return t.assign_to!==WB.currentUser;});wbUpdateAssignedBadge();wbRenderAssignedTasks();finish();},error:finish
  });
};

// ══════════════════════════════════════════════
//  Modal
// ══════════════════════════════════════════════
window.wbOpenModal = function(taskName, context) {
  var all = WB.myTasks.concat(WB.assignedTasks);
  var task = null;
  for (var i=0; i<all.length; i++) { if (all[i].name===taskName) { task=all[i]; break; } }
  if (!task) return;
  WB.modalTask = task;
  WB.modalContext = context;

  $id('wb-modal-title').textContent = task.title;
  $id('wb-modal-subtitle').textContent = task.name;

  // Badges
  $id('wb-modal-badges').innerHTML =
    '<span class="wb-badge wb-badge-'+esc(task.status)+'">'+esc(task.status)+'</span>'+
    '<span class="wb-badge wb-badge-'+esc(task.priority)+'">'+esc(task.priority)+'</span>'+
    (task.task_type?'<span class="wb-badge wb-badge-'+esc(task.task_type)+'">'+esc(task.task_type)+'</span>':'')+
    (task.depends_on_time?'<span class="wb-badge wb-badge-time"><i class="fa-solid fa-clock"></i> Time-Based</span>':'')+
    (task.timeliness?'<span class="wb-badge" style="background:#e0f2fe;color:#0369a1;">'+esc(task.timeliness)+'</span>':'');

  // Detail cells
  var cells = [
    detailCell('blue','fa-calendar-day','Due Date', fmtDate(task.due_date)),
    detailCell('gray','fa-user-tie','Assigned From', task.assign_from||'–'),
    detailCell('blue','fa-user','Assigned To', task.assign_to||'–')
  ];
  if (task.depends_on_time && task.end_datetime) {
    var tl = timeLeft(task.end_datetime);
    var color = tl.expired ? 'red' : 'amber';
    cells.push(detailCell(color,'fa-hourglass-half','Deadline',fmtDatetime(task.end_datetime)));
    cells.push(detailCell(color,'fa-stopwatch','Time Left',tl.label));
  }
  $id('wb-modal-detail-grid').innerHTML = cells.join('');

  // Description
  if (task.description) {
    $id('wb-modal-desc-section').classList.remove('hidden');
    $id('wb-modal-description').innerHTML = task.description;
  } else {
    $id('wb-modal-desc-section').classList.add('hidden');
  }

  wbRenderModalActions();
  $id('wb-modal-overlay').classList.remove('hidden');
};

function detailCell(iconColor, icon, label, value) {
  return '<div class="wb-detail-cell">'+
    '<div class="wb-cell-icon '+iconColor+'"><i class="fa-solid '+icon+'"></i></div>'+
    '<div class="wb-cell-text"><div class="label">'+esc(label)+'</div><div class="value">'+esc(value)+'</div></div>'+
  '</div>';
}

function wbRenderModalActions() {
  var task = WB.modalTask;
  var context = WB.modalContext;
  var actions = ['<button class="wb-modal-action-btn secondary" onclick="wbCloseModal()"><i class="fa-solid fa-xmark"></i>Close</button>'];

  if (context === 'mine') {
    if (['Open','Overdue'].includes(task.status) && task.task_type === 'Manual') {
      actions.push('<button class="wb-modal-action-btn primary-done" onclick="wbMarkDone(\''+esc(task.name)+'\',this)"><i class="fa-solid fa-check"></i>Mark Done</button>');
    } else if (['Open','Overdue'].includes(task.status) && task.task_type === 'Auto') {
      actions.push('<button class="wb-modal-action-btn primary-complete" onclick="wbMarkCompleted(\''+esc(task.name)+'\',this)"><i class="fa-solid fa-check-double"></i>Mark Completed</button>');
    }
  } else if (context === 'assigned' && task.status === 'Done') {
    actions.push('<button class="wb-modal-action-btn primary-complete" onclick="wbMarkCompleted(\''+esc(task.name)+'\',this)"><i class="fa-solid fa-circle-check"></i>Approve & Complete</button>');
  }
  $id('wb-modal-actions').innerHTML = actions.join('');
}

window.wbCloseModal = function() {
  $id('wb-modal-overlay').classList.add('hidden');
  WB.modalTask = null;
};

document.getElementById('wb-modal-overlay').addEventListener('click', function(e){
  if (e.target === this) wbCloseModal();
});

// ══════════════════════════════════════════════
//  Init – resolve user via API (works in website context)
// ══════════════════════════════════════════════
function wbInit() {
  // frappe.call may not be ready immediately on website pages
  if (typeof frappe === 'undefined' || typeof frappe.call === 'undefined') {
    setTimeout(wbInit, 200);
    return;
  }

  frappe.call({
    method: 'frappe.client.get_value',
    args: { doctype: 'User', filters: { name: 'Session User' }, fieldname: ['name', 'full_name'] },
    callback: function(r) {
      var user = r && r.message && r.message.name ? r.message.name : null;

      // Fallback: try frappe.session directly
      if (!user && frappe.session && frappe.session.user) {
        user = frappe.session.user;
      }

      if (!user || user === 'Guest') {
        window.location.href = '/login?redirect-to=' + encodeURIComponent(window.location.pathname);
        return;
      }

      WB.currentUser = user;
      var fullName = (r && r.message && r.message.full_name) ? r.message.full_name : user;
      $id('wb-user-label').textContent = fullName;

      wbFetchMyTasks();
      wbFetchAssignedTasks();
    },
    error: function() {
      // Last resort fallback
      if (frappe.session && frappe.session.user && frappe.session.user !== 'Guest') {
        WB.currentUser = frappe.session.user;
        $id('wb-user-label').textContent = WB.currentUser;
        wbFetchMyTasks();
        wbFetchAssignedTasks();
      } else {
        window.location.href = '/login?redirect-to=' + encodeURIComponent(window.location.pathname);
      }
    }
  });
}

wbInit();

})();
</script>
